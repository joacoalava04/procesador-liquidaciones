<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Liquidaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            padding: 2rem;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <div class="container bg-white p-8 rounded-xl shadow-lg border border-gray-200">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                Procesador de Liquidaciones de Tarjetas
            </h1>
            <p class="text-gray-600">
                Selecciona uno o más archivos PDF de liquidación para procesarlos y analizarlos.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="bankSelect" class="block text-sm font-medium text-gray-700 mb-1">
                    Selecciona el Banco
                </label>
                <select id="bankSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="fiserv">Fiserv (Visa)</option>
                    <option value="cabal">Cabal</option>
                    <option value="amex">Amex</option>
                    <option value="bankA">Banco A (Ejemplo)</option>
                    <option value="bankB">Banco B (Ejemplo)</option>
                </select>
            </div>
            <div>
                <label for="liquidationFile" class="block text-sm font-medium text-gray-700 mb-1">
                    Selecciona los archivos de liquidación (PDF)
                </label>
                <input type="file" id="liquidationFile" accept="application/pdf" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
            </div>
        </div>

        <div class="flex justify-center md:gap-4 flex-col md:flex-row mb-6">
            <button id="processButton" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors mb-2 md:mb-0">
                Procesar Liquidación
            </button>
            <button id="inspectButton" class="w-full md:w-auto px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 transition-colors">
                Inspeccionar Archivo
            </button>
        </div>
        
        <div id="loadingMessage" class="text-center text-gray-500 hidden mb-4">
            Procesando PDF, por favor espera...
        </div>

        <div id="results" class="bg-gray-50 p-6 rounded-lg border border-gray-200 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Resultados</h2>
            <div id="resultsContent" class="overflow-x-auto">
                <!-- Los resultados se mostrarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        // Configura el worker de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        document.getElementById('processButton').addEventListener('click', async function() {
            const fileInput = document.getElementById('liquidationFile');
            const bank = document.getElementById('bankSelect').value;
            const resultsDiv = document.getElementById('results');
            const resultsContentDiv = document.getElementById('resultsContent');
            const loadingMessage = document.getElementById('loadingMessage');

            const files = fileInput.files;
            if (files.length === 0) {
                displayMessage('Por favor, selecciona al menos un archivo PDF.', 'error');
                return;
            }

            // Ocultar resultados y mostrar mensaje de carga
            resultsDiv.classList.add('hidden');
            loadingMessage.classList.remove('hidden');

            try {
                const totalSummary = {};

                for (const file of files) {
                    // Leer el archivo como un ArrayBuffer
                    const arrayBuffer = await readFileAsync(file);
                    
                    // Cargar y procesar el PDF
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const textItems = textContent.items.map(item => item.str);
                        fullText += textItems.join('\n') + '\n';
                    }

                    // Procesar los datos extraídos del PDF y agregarlos al resumen total
                    const fileSummary = processLiquidation(bank, fullText);
                    if (fileSummary) {
                        for (const key in fileSummary) {
                            if (totalSummary[key]) {
                                totalSummary[key] += fileSummary[key];
                            } else {
                                totalSummary[key] = fileSummary[key];
                            }
                        }
                    }
                }
                
                // Mostrar resultados y ocultar mensaje de carga
                if (Object.keys(totalSummary).length > 0) {
                    displayResults({ bank: 'Total Consolidado', summary: totalSummary });
                    resultsDiv.classList.remove('hidden');
                } else {
                    displayMessage('No se encontraron datos de liquidación en los archivos seleccionados.', 'info');
                }
            } catch (error) {
                console.error("Error al procesar el PDF:", error);
                displayMessage('Hubo un error al procesar los archivos. Asegúrate de que son PDFs válidos.', 'error');
            } finally {
                loadingMessage.classList.add('hidden');
            }
        });
        
        document.getElementById('inspectButton').addEventListener('click', async function() {
            const fileInput = document.getElementById('liquidationFile');
            const resultsDiv = document.getElementById('results');
            const resultsContentDiv = document.getElementById('resultsContent');
            const loadingMessage = document.getElementById('loadingMessage');

            const file = fileInput.files[0];
            if (!file) {
                displayMessage('Por favor, selecciona un archivo PDF para inspeccionar.', 'error');
                return;
            }
            
            // Ocultar resultados y mostrar mensaje de carga
            resultsDiv.classList.add('hidden');
            loadingMessage.classList.remove('hidden');

            try {
                // Leer el archivo como un ArrayBuffer
                const arrayBuffer = await readFileAsync(file);
                
                // Cargar y procesar el PDF
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const textItems = textContent.items.map(item => item.str);
                    fullText += textItems.join('\n') + '\n\n' + '--- FIN DE PÁGINA ' + i + ' ---\n\n';
                }

                // Mostrar el texto completo en el área de resultados
                resultsContentDiv.innerHTML = `<h3 class="text-xl font-semibold mb-2">Texto extraído del PDF:</h3><pre class="whitespace-pre-wrap text-gray-700 text-sm p-4 bg-gray-100 rounded-lg">${fullText}</pre>`;
                resultsDiv.classList.remove('hidden');
            } catch (error) {
                console.error("Error al inspeccionar el PDF:", error);
                displayMessage('Hubo un error al leer el archivo. Asegúrate de que es un PDF válido.', 'error');
            } finally {
                loadingMessage.classList.add('hidden');
            }
        });

        // Función auxiliar para leer un archivo de forma asíncrona
        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Función auxiliar para mostrar mensajes al usuario
        function displayMessage(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultsContentDiv = document.getElementById('resultsContent');
            resultsDiv.classList.remove('hidden');
            resultsDiv.classList.add('bg-white', 'p-6', 'rounded-lg', 'border', 'border-gray-200');
            resultsContentDiv.innerHTML = `<p class="text-center font-semibold ${type === 'error' ? 'text-red-600' : 'text-gray-500'}">${message}</p>`;
        }
        
        // Función auxiliar para convertir números con formato español (separador de miles '.' y decimal ',')
        function parseSpanishNumber(numStr) {
            if (!numStr) return 0;
            const isNegative = numStr.includes('-') || numStr.includes('−');
            const cleanStr = numStr.replace(/\./g, '').replace(',', '.').replace(/[−-]/g, '');
            const value = parseFloat(cleanStr);
            return isNegative ? -value : value;
        }
        
        // Función para formatear números al estilo español (1.234,56)
        function formatSpanishNumber(num) {
            return num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Una lista explícita de conceptos que son deducciones
        const negativeConcepts = [
            "ARANCEL",
            "IVA",
            "IVA CRED.FISC.COMERCIO S/ARANC 21,00%",
            "DTO S/VENTAS FIN ADQ CONT",
            "ARANCEL CUOTAS",
            "DTO S/VENTAS FIN ADQ CUOTA",
            "IVA ARANCEL CUOTAS 21,00%",
            "IVA S/DTO FIN ADQ CONT 21,00%",
            "IVA S/DTO FIN ADQ CUOTA 21,00%",
            "PERCEPCION IVA R.G. 2408 1,50 %",
            "PERCEPCION IVA R.G. 2408 3,00 %",
            "SERVICIO OPER. INTERNAC.",
            "IVA RI SERV.OPER. INT.",
            "QR PERCEPCION IVA 3337",
            "CARGO SISTEMA CUOTAS MENS",
            "IVA RI SIST CUOTAS",
            "PROMO CUOTA AHORA/SIMPLE",
            "IVA PROMO CUOTA AHORA/SIMPLE 10,50%",
            "DESCUENTO FINANC.OTORG. CUOTAS",
            "IVA CRED.FISC.COM.L.25063 S/DTO F.OTOR 10,50%",
            "CARGO TERMINAL FISERV",
            "ARANCEL DE DESCUENTO",
            "IVA S/ARANCEL DE DESCUENTO 21,00%",
            "IVA S/ARANCEL DE DESCUENTO 10,50%",
            "COSTO FINANCIERO TOTAL",
            "IVA S/COSTO FINANCIERO",
            "IVA S/COSTO FINANCIERO 10,50%",
            "PERCEPCION DE IVA RG 333 1,50%",
            "PERCEPCION DE IVA RG 333 3,00%",
            "TOTAL DEBITOS",
            "IVA DE DEBITOS",
            "COMISION ADMINISTRACION P",
            "DESCUENTO POR SERVICIOS",
            "RETENCIONES IMPOSITIVAS",
            "IVA DEBITO FISCAL",
            "PERCEPCION IVA R.G. DGI 3337",
            "Monto Descuento",
            "Descuento por servicios",
            "Retenciones impositivas"
        ];

        // Function that processes the PDF text and extracts all concepts and their amounts.
        function processLiquidation(bank, data) {
            const summary = {};
            
            switch (bank) {
                case 'fiserv':
                    // Mapping of concepts and their search patterns for precise extraction.
                    const fiservConcepts = {
                        "VENTAS C/DTO ANTIC POR FINANC ADQUIREN": /VENTAS C\/DTO ANTIC POR FINANC ADQUIREN\s*[\+]\s*\$\s*([\d\.\,]+)/g,
                        "ARANCEL": /ARANCEL\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA CRED.FISC.COMERCIO S/ARANC 21,00%": /IVA CRED\.FISC\.COMERCIO S\/ARANC 21,00%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "DTO S/VENTAS FIN ADQ CONT": /DTO S\/VENTAS FIN ADQ CONT\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "ARANCEL CUOTAS": /ARANCEL CUOTAS\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "DTO S/VENTAS FIN ADQ CUOTA": /DTO S\/VENTAS FIN ADQ CUOTA\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA ARANCEL CUOTAS 21,00%": /IVA ARANCEL CUOTAS 21,00%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA S/DTO FIN ADQ CONT 21,00%": /IVA S\/DTO FIN ADQ CONT 21,00%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA S/DTO FIN ADQ CUOTA 21,00%": /IVA S\/DTO FIN ADQ CUOTA 21,00%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "PERCEPCION IVA R.G. 2408 1,50 %": /PERCEPCION IVA R\.G\. 2408\s+1,50\s*%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "PERCEPCION IVA R.G. 2408 3,00 %": /PERCEPCION IVA R\.G\. 2408\s+3,00\s*%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IMPORTE NETO DE PAGOS": /IMPORTE NETO DE PAGOS\s*\$\s*([\d\.\,]+)/g,
                        "VENTAS C/DESCUENTO CONTADO": /VENTAS C\/DESCUENTO CONTADO\s*[\+]\s*\$\s*([\d\.\,]+)/g,
                        "VENTAS C/DTO PLAN CUOTAS": /VENTAS C\/DTO PLAN CUOTAS\s*[\+]\s*\$\s*([\d\.\,]+)/g,
                        "SERVICIO OPER. INTERNAC.": /SERVICIO OPER\. INTERNAC\.\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA RI SERV.OPER. INT.": /IVA RI SERV\.OPER\. INT\.\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "QR AJUSTES": /QR AJUSTES\s*[\+]\s*\$\s*([\d\.\,]+)/g,
                        "QR PERCEPCION IVA 3337": /QR PERCEPCION IVA 3337\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "CARGO SISTEMA CUOTAS MENS": /CARGO SISTEMA CUOTAS MENS\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA RI SIST CUOTAS": /IVA RI SIST CUOTAS\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "VENTAS C/DTO CUOTAS FINANC. OTORG.": /VENTAS C\/DTO CUOTAS FINANC\. OTORG\.\s*[\+]\s*\$\s*([\d\.\,]+)/g,
                        "PROMO CUOTA AHORA/SIMPLE": /PROMO CUOTA AHORA\/SIMPLE\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA PROMO CUOTA AHORA\/SIMPLE 10,50%": /IVA PROMO CUOTA AHORA\/SIMPLE 10,50%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "DESCUENTO FINANC.OTORG. CUOTAS": /DESCUENTO FINANC\.OTORG\. CUOTAS\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "IVA CRED.FISC.COM.L.25063 S/DTO F.OTOR 10,50%": /IVA CRED\.FISC\.COM\.L\.25063 S\/DTO F\.OTOR 10,50%\s*[-−]\s*\$\s*([\d\.\,]+)/g,
                        "CARGO TERMINAL FISERV": /CARGO TERMINAL FISERV\s*[-−]\s*\$\s*([\d\.\,]+)/g
                    };
                    
                    for (const concept in fiservConcepts) {
                        const regex = fiservConcepts[concept];
                        const matches = [...data.matchAll(regex)];
                        let total = 0;
                        for (const match of matches) {
                            total += parseSpanishNumber(match[1]);
                        }
                        if (total !== 0) {
                           summary[concept] = total;
                        }
                    }
                    return summary;

                case 'cabal':
                    // Regexes for Cabal concepts, updated to be more robust
                    const cabalConcepts = {
                        "TOTAL DE VENTAS": /TOTAL DE VENTAS\. CANTIDAD\.\.\.\s*\d+\s*([\d\.\,]+)/g,
                        "ARANCEL DE DESCUENTO": /ARANCEL DE DESCUENTO\s*([\d\.\,]+[-−])/g,
                        "IVA S/ARANCEL DE DESCUENTO 21,00%": /IVA S\/ARANCEL DE DESCUENTO\s*21,00%\s*([\d\.\,]+[-−])/g,
                        "IVA S/ARANCEL DE DESCUENTO 10,50%": /IVA S\/ARANCEL DE DESCUENTO\s*10,50%\s*([\d\.\,]+[-−])/g,
                        "COSTO FINANCIERO TOTAL": /COSTO FINANCIERO TOTAL\s*([\d\.\,]+[-−])/g,
                        "IVA S/COSTO FINANCIERO": /IVA S\/COSTO FINANCIERO\s*([\d\.\,]+[-−])/g,
                        "IVA S/COSTO FINANCIERO 10,50%": /IVA S\/COSTO FINANCIERO\s*10,50%\s*([\d\.\,]+[-−])/g,
                        "PERCEPCION DE IVA RG 333 1,50%": /PERCEPCION DE IVA RG 333\s*1,50%\s*[\d\.\,]+\s*([\d\.\,]+[-−])/g,
                        "PERCEPCION DE IVA RG 333 3,00%": /PERCEPCION DE IVA RG 333\s*3,00%\s*[\d\.\,]+\s*([\d\.\,]+[-−])/g,
                        // Regex mejorado para capturar el valor correcto al final de la sección
                        "TOTAL DEBITOS": /[−-]TOTAL DEBITOS[\s\S]*?([\d\.\,]+)−/g,
                        // Regex para el IVA
                        "IVA": /[−-]IVA[\s\S]*?([\d\.\,]+)−/g,
                        "COMISION ADMINISTRACION P": /COMISION ADMINISTRACION P\s*[\w\d\.\/\:\- ]*\s*([\d\.\,]+[-−])/g,
                        "NETO A LIQUIDAR POR VENTAS": /NETO A LIQUIDAR POR VENTAS\s*([\d\.\,]+)/g
                    };
                    
                    for (const concept in cabalConcepts) {
                        const regex = cabalConcepts[concept];
                        const matches = [...data.matchAll(regex)];
                        let total = 0;
                        for (const match of matches) {
                            // Usar el primer grupo capturado, que es el valor numérico
                            total += parseSpanishNumber(match[1]);
                        }
                        if (total !== 0) {
                           summary[concept] = total;
                        }
                    }
                    return summary;

                case 'amex':
                    const amexSummary = {};
                    const amexConcepts = {
                        // Regex mejorado para buscar el valor seguido de un guión
                        "IVA DEBITO FISCAL": /IVA\s+DEBITO\s+FISCAL\s+([\d\.\,]+-)/g,
                        "PERCEPCION IVA R.G. DGI 3337": /PERCEP\s+IVA\s+R\.G\.\s+DGI\s+3337\s+([\d\.\,]+-)/g,
                    };

                    // Procesa el bloque de totales que no tienen una etiqueta explícita
                    // Búsqueda de la etiqueta "TOTAL PROCESADAS" con mayor flexibilidad
                    const transaccionesRegex = /TOTAL[\s\S]*?PROCESADAS[\s\S]*?([\d\.\,]+)[\s\S]*?([\d\.\,]+-?)[\s\S]*?([\d\.\,]+-?)[\s\S]*?([\d\.\,]+)[\s\S]*?([\d\.\,]+-?)[\s\S]*?([\d\.\,]+)/;
                    const transaccionesMatches = data.match(transaccionesRegex);
                    
                    if (transaccionesMatches) {
                        amexSummary["Monto Bruto"] = parseSpanishNumber(transaccionesMatches[1]);
                        amexSummary["Monto Descuento"] = parseSpanishNumber(transaccionesMatches[2]);
                        amexSummary["Descuento por servicios"] = parseSpanishNumber(transaccionesMatches[3]);
                        amexSummary["Monto de credito"] = parseSpanishNumber(transaccionesMatches[4]);
                        amexSummary["Retenciones impositivas"] = parseSpanishNumber(transaccionesMatches[5]);
                        amexSummary["Monto Neto"] = parseSpanishNumber(transaccionesMatches[6]);
                    }

                    // Procesa los otros conceptos que tienen etiquetas claras
                    for (const concept in amexConcepts) {
                        const regex = amexConcepts[concept];
                        const matches = [...data.matchAll(regex)];
                        let total = 0;
                        for (const match of matches) {
                            total += parseSpanishNumber(match[1]);
                        }
                        if (total !== 0) {
                           amexSummary[concept] = total;
                        }
                    }

                    return amexSummary;

                case 'bankA':
                    const linesA = data.trim().split('\n');
                    summary.totalVenta = 0; summary.totalImpuesto = 0; summary.totalComision = 0; summary.totalPago = 0;
                    linesA.forEach(line => {
                        const [type, value] = line.split(',').map(s => s.trim());
                        const numericValue = parseFloat(value);
                        if (!isNaN(numericValue)) {
                            switch (type.toUpperCase()) {
                                case 'VENTA': summary.totalVenta += numericValue; break;
                                case 'IMPUESTO': summary.totalImpuesto += numericValue; break;
                                case 'COMISION': summary.totalComision += numericValue; break;
                                case 'PAGO': summary.totalPago += numericValue; break;
                            }
                        }
                    });
                    return summary;

                case 'bankB':
                    const linesB = data.trim().split('\n');
                    summary.totalVenta = 0; summary.totalImpuesto = 0; summary.totalComision = 0; summary.totalPago = 0;
                    linesB.forEach(line => {
                        const [venta, impuesto, comision, pago] = line.split(',').map(s => parseFloat(s.trim()));
                        if (!isNaN(venta)) {
                            summary.totalVenta += venta;
                            summary.totalImpuesto += impuesto;
                            summary.totalComision += comision;
                            summary.totalPago += pago;
                        }
                    });
                    return summary;

                default:
                    return null;
            }
        }

        function displayResults(data) {
            const resultsContentDiv = document.getElementById('resultsContent');
            resultsContentDiv.innerHTML = '';
            
            const summaryHTML = `
                <div class="mb-4">
                    <h3 class="text-2xl font-semibold mb-4 text-center">Resumen ${data.bank}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        ${Object.entries(data.summary).map(([key, value]) => `
                            <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                <span class="font-medium text-gray-700">${key}:</span>
                                <span class="font-bold ${value >= 0 ? 'text-blue-600' : 'text-red-600'}">
                                    ${formatSpanishNumber(value)}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            resultsContentDiv.innerHTML = summaryHTML;
        }
    </script>
</body>
</html>
